name: CI

on:
  push:
    branches:
      - "main"
      - "release/**"
      - "feature/**"
      - "codex/**"
    tags:
      - "v*"
  pull_request:
    branches: ["main"]
  workflow_dispatch:

permissions:
  contents: read

env:
  SONAR_HOST_URL: https://sonarcloud.io
  SONAR_PROJECT_KEY: ${{ vars.SONAR_PROJECT_KEY }}
  SONAR_ORGANIZATION: ${{ vars.SONAR_ORGANIZATION }}
  SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

jobs:
  build-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'
          cache: maven

      - name: Build and test
        env:
          DOCKER_API_VERSION: "1.44"
        run: mvn -B clean verify

      - name: SonarCloud analysis
        if: ${{ env.SONAR_TOKEN != '' }}
        continue-on-error: true
        run: >
          mvn -B -DskipTests
          org.sonarsource.scanner.maven:sonar-maven-plugin:sonar
          -Dsonar.token=${SONAR_TOKEN}
          -Dsonar.host.url=${SONAR_HOST_URL}
          -Dsonar.organization=${SONAR_ORGANIZATION:-vrushankpatel}
          -Dsonar.projectKey=${SONAR_PROJECT_KEY:-VrushankPatel_shield}
          -Dsonar.coverage.jacoco.xmlReportPaths=target/site/jacoco/jacoco.xml,target/site/jacoco-it/jacoco.xml

      - name: Upload JaCoCo report
        uses: actions/upload-artifact@v4
        with:
          name: jacoco-report
          path: |
            target/site/jacoco/
            target/site/jacoco-it/

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: target/site/jacoco/jacoco.xml,target/site/jacoco-it/jacoco.xml
          fail_ci_if_error: true
          verbose: true

  performance-baseline:
    runs-on: ubuntu-latest
    needs: build-test
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'
          cache: maven

      - name: Start dependent services
        run: docker compose --env-file dev.env up -d postgres redis

      - name: Package app
        run: mvn -B -DskipTests clean package

      - name: Start app
        run: |
          set -a && source dev.env && set +a
          nohup java -jar target/shield-*.jar > app.log 2>&1 &
          echo $! > app.pid

      - name: Wait for health endpoint
        run: |
          for i in {1..60}; do
            if curl -fsS "http://localhost:8080/actuator/health" >/dev/null; then
              exit 0
            fi
            sleep 2
          done
          echo "Application did not become healthy in time." >&2
          tail -n 200 app.log || true
          exit 1

      - name: Run k6 baseline
        run: |
          docker run --rm --network host \
            -v "${{ github.workspace }}:/workspace" \
            -w /workspace \
            grafana/k6:0.49.0 run scripts/performance/k6-smoke.js

      - name: Run k6 authenticated baseline
        run: |
          docker run --rm --network host \
            -v "${{ github.workspace }}:/workspace" \
            -w /workspace \
            grafana/k6:0.49.0 run scripts/performance/k6-authenticated-flow.js

      - name: Upload performance artifact
        uses: actions/upload-artifact@v4
        with:
          name: performance-baseline
          path: |
            performance-summary.json
            performance-authenticated-summary.json
            app.log

      - name: Cleanup performance stack
        if: always()
        run: |
          if [[ -f app.pid ]]; then
            kill "$(cat app.pid)" || true
          fi
          docker compose --env-file dev.env down -v || true

  docker-build:
    runs-on: ubuntu-latest
    needs: build-test
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'
          cache: maven

      - name: Package app
        run: mvn -B -DskipTests clean package

      - name: Build Docker image
        run: docker build -t shield-api:${{ github.sha }} .

  publish-ghcr:
    runs-on: ubuntu-latest
    needs: build-test
    if: github.event_name == 'push'
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'
          cache: maven

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Resolve image name
        id: image
        run: |
          OWNER_LC="$(echo '${{ github.repository_owner }}' | tr '[:upper:]' '[:lower:]')"
          echo "image=ghcr.io/${OWNER_LC}/shield" >> "$GITHUB_OUTPUT"

      - name: Resolve project version
        id: version
        run: |
          VERSION="$(mvn -q -DforceStdout help:evaluate -Dexpression=project.version | tail -n 1)"
          echo "value=${VERSION}" >> "$GITHUB_OUTPUT"

      - name: Resolve docker metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ steps.image.outputs.image }}
          tags: |
            type=raw,value=${{ steps.version.outputs.value }}
            type=ref,event=branch
            type=ref,event=tag
            type=sha
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Package app for Docker context
        run: mvn -B -DskipTests clean package

      - name: Build and push GHCR image
        uses: docker/build-push-action@v6
        with:
          context: .
          provenance: false
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
